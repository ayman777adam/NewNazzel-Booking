<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ù…Ù†Ø¸ÙˆÙ…Ø© Adora Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ø§Ù„Ù‚Ù†Ø§Øµ)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    /* V18.0 Priority Fix Style */
    :root {
        --primary: #00838f; --primary-soft: #e0f7fa; --accent: #ff6f00;        
        --bg-body: #f0f4f8; --text-dark: #263238; --text-light: #546e7a;
        --shadow-card: 0 10px 20px rgba(0, 131, 143, 0.06);
        --radius: 16px;
        --grad-blue: linear-gradient(135deg, #2980b9, #6dd5fa);
        --grad-ok: linear-gradient(135deg, #00b09b, #96c93d);
        --grad-warn: linear-gradient(135deg, #f2994a, #f2c94c);
        --grad-err: linear-gradient(135deg, #eb3349, #f45c43);
        --grad-purple: linear-gradient(135deg, #8e2de2, #4a00e0);
    }
    * { box-sizing: border-box; outline: none; }
    body { 
        margin: 0; padding: 0 0 60px 0; font-family: 'Tajawal', sans-serif; 
        color: var(--text-dark); background-color: var(--bg-body);
        background-image: linear-gradient(135deg, rgba(0, 131, 143, 0.03) 25%, transparent 25%), 
            linear-gradient(225deg, rgba(0, 131, 143, 0.03) 25%, transparent 25%), 
            linear-gradient(45deg, rgba(0, 131, 143, 0.03) 25%, transparent 25%), 
            linear-gradient(315deg, rgba(0, 131, 143, 0.03) 25%, transparent 25%);
        background-position: 10px 0, 10px 0, 0 0, 0 0; background-size: 80px 80px;
        background-attachment: fixed;
    }
    .app-header {
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
        padding: 10px 25px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000;
        display: flex; justify-content: space-between; align-items: center;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo-img { height: 40px; width: auto; } 
    .brand-info h1 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--primary); }
    .brand-info p { margin: 0; font-size: 0.7rem; color: var(--text-light); }
    .header-tools { display: flex; gap: 10px; }
    .btn-chic {
        background: #fff; border: 1px solid #e0e0e0; padding: 8px 16px;
        border-radius: 10px; cursor: pointer; transition: 0.2s;
        display: flex; align-items: center; gap: 8px;
        font-weight: 700; color: var(--text-dark); font-size: 0.85rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .btn-chic:hover { border-color: var(--primary); transform: translateY(-2px); }
    .hero-card { margin: 30px auto; max-width: 800px; padding: 0 20px; animation: slideIn 0.5s ease-out; }
    .upload-box {
        background: #fff; border-radius: var(--radius); padding: 30px;
        box-shadow: var(--shadow-card); text-align: center; position: relative;
    }
    .upload-box::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }
    .drop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
    .drop-zone {
        border: 2px dashed #cfd8dc; border-radius: 15px; padding: 25px;
        transition: 0.3s; cursor: pointer; background: #fafafa;
    }
    .drop-zone:hover { border-color: var(--primary); background: #e0f7fa; }
    .drop-zone.file-loaded { border-color: #27ae60; background: #e8f5e9; }
    .drop-zone i { font-size: 2rem; color: #b0bec5; }
    .drop-zone h3 { margin: 10px 0 0; font-size: 0.9rem; color: var(--text-dark); }
    .drop-zone input { display: none; }
    .btn-magic {
        background: linear-gradient(135deg, var(--primary), #00acc1); color: #fff; border: none;
        padding: 12px 40px; border-radius: 50px; font-size: 1rem; font-weight: 800;
        cursor: pointer; box-shadow: 0 8px 20px rgba(0, 131, 143, 0.2); transition: 0.3s;
        display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-magic:hover { transform: translateY(-2px); }
    .control-panel { display: none; justify-content: center; gap: 15px; margin: 0 auto 20px; }
    .tax-settings {
        display: flex; gap: 15px; background: #fff; padding: 6px 15px; 
        border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee;
    }
    .tax-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: 700; color: var(--primary); }
    .tax-inp { width: 45px; text-align: center; border: 1px solid #ddd; border-radius: 10px; padding: 3px; color: var(--accent); font-weight: 800; }
    .dashboard {
        display: none; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 12px; padding: 0 25px; max-width: 1250px; margin: 0 auto 20px;
        animation: fadeIn 0.6s ease;
    }
    .kpi-card {
        background: #fff; border-radius: 12px; padding: 12px 10px;
        box-shadow: var(--shadow-card); text-align: center; position: relative;
        transition: 0.3s; border: 1px solid #fcfcfc;
    }
    .kpi-card:hover { transform: translateY(-3px); }
    .kpi-icon {
        width: 32px; height: 32px; border-radius: 10px; margin: 0 auto 5px;
        display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.9rem;
    }
    .k-blue .kpi-icon { background: var(--grad-blue); }
    .k-green .kpi-icon { background: var(--grad-ok); }
    .k-red .kpi-icon { background: var(--grad-err); }
    .k-gold .kpi-icon { background: var(--grad-warn); }
    .k-purple .kpi-icon { background: var(--grad-purple); }
    .kpi-num { font-size: 1.1rem; font-weight: 800; color: var(--text-dark); display: block; margin-bottom: 2px; }
    .kpi-lbl { font-size: 0.65rem; color: var(--text-light); font-weight: 700; }
    .sub-stats {
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px;
        margin-top: 8px; padding-top: 5px; border-top: 1px dashed #eee;
    }
    .mini { background: #f8f9fa; border-radius: 6px; padding: 3px; display: flex; flex-direction: column; align-items: center; }
    .mini b { font-size: 0.75rem; } .mini span { font-size: 0.55rem; color: #90a4ae; font-weight: 600; }
    .booking-logo { height: 14px; vertical-align: middle; opacity: 0.9; }
    .results-wrap { display: none; padding: 0 25px; max-width: 1250px; margin: 0 auto; }
    .filter-pills { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
    .pill {
        white-space: nowrap; padding: 6px 18px; border-radius: 20px; background: #fff; border: 1px solid #eee;
        font-weight: 700; font-size: 0.75rem; color: var(--text-light); cursor: pointer; transition: 0.2s;
    }
    .pill.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .pill.red.active { background: #c0392b; border-color: #c0392b; }
    .search-box {
        width: 100%; padding: 10px 20px; border-radius: 12px; border: 2px solid #eee;
        background: #fff; font-size: 0.9rem; margin-bottom: 20px;
    }
    .table-responsive { background: transparent; overflow-x: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; min-width: 900px; }
    thead th {
        background: transparent; color: var(--text-light); padding: 8px 15px;
        text-align: right; font-weight: 700; font-size: 0.75rem; border: none;
        cursor: pointer; user-select: none;
    }
    tbody tr { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
    tbody tr:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.06); }
    tbody td {
        padding: 12px 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee;
        font-size: 0.85rem; vertical-align: middle;
    }
    tbody td:first-child { border-left: 1px solid #eee; border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    tbody td:last-child { border-right: 1px solid #eee; border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
    .st-ok { background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 800; }
    .st-no { background: #ffebee; color: #c62828; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 800; }
    .match-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 5px; font-weight: 700; white-space: nowrap; }
    .mt-ok { background: var(--primary-soft); color: var(--primary-dark); }
    .mt-warn { background: #fff8e1; color: #f57f17; }
    .mt-err { background: #ffebee; color: #c62828; }
    .mt-grp { background: #f3e5f5; color: #8e24aa; }
    .mt-guess { background: #e0f2f1; color: #00695c; border:1px solid #b2dfdb; }
    .mt-miss { background: #eceff1; color: #78909c; }
    .mt-alias { background: #e3f2fd; color: #1565c0; border:1px solid #90caf9; }
    .mt-ext { background: #fffde7; color: #fbc02d; border:1px solid #ffee58; }
    .b-name { font-weight: 800; color: var(--primary); font-size: 0.85rem; }
    .b-ref { font-size: 0.65rem; color: #b0bec5; }
    .price-val { font-weight: 700; font-size: 0.85rem; }
    .diff-pos { color: #27ae60; font-weight: 800; } .diff-neg { color: #c0392b; font-weight: 800; }
    .d-box { display: flex; flex-direction: column; gap: 4px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
    .d-line { display: flex; align-items: center; gap: 8px; }
    .d-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
    .dot-b { background: #2980b9; } .txt-b { color: #2980b9; }
    .dot-n { background: #27ae60; } .txt-n { color: #27ae60; }
    .btn-mini { padding: 4px 10px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; cursor: pointer; border: none; color: #fff; margin-top: 3px; }
    .bm-merge { background: #8e44ad; }
    .diff-diag { font-size: 0.7rem; color: #90a4ae; font-weight: 600; }
    .footer-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); padding: 10px; text-align: center; font-size: 0.75rem; color: var(--text-light); font-weight: 600; border-top: 1px solid #eee; z-index: 999; }
    .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    @media print {
        body { background: #fff; color: #000; font-size: 9pt; }
        .app-header, .hero-card, .filter-pills, .search-box, .footer-bar, .control-panel, .dashboard { display: none !important; }
        .results-wrap { display: block !important; padding: 0; margin: 20px; width: 98%; }
        .table-responsive { box-shadow: none; border: none; overflow: visible; }
        table { border-collapse: collapse; width: 100%; border: 1px solid #000; margin-top: 10px; }
        th { background: #d9d9d9 !important; color: #000 !important; border: 1px solid #000; padding: 4px 6px; font-size: 9pt; font-weight: bold; text-align: center; }
        td { border: 1px solid #000; padding: 3px 5px; color: #000 !important; font-size: 8pt; height: auto; vertical-align: middle; }
        tbody tr { box-shadow: none !important; background: transparent !important; margin: 0 !important; }
        tbody td:first-child, tbody td:last-child { border-radius: 0; border: 1px solid #000; }
        table { border-spacing: 0; }
        .btn-mini, .logo-img, .d-dot, .sub-stats, .diff-diag { display: none !important; }
        .d-box { display: block; font-weight: normal; font-size: 8pt; }
        .d-line { display: block; margin-bottom: 2px; }
        .txt-b, .txt-n { color: #000 !important; }
        .badge, .status-badge, .match-tag { border: none; background: transparent !important; color: #000 !important; padding: 0; font-weight: normal; }
        * { -webkit-print-color-adjust: exact; color: #000 !important; }
        .results-wrap::before { content: "ØªÙ‚Ø±ÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª - Adora System (V18.0)"; display: block; text-align: center; font-size: 14pt; font-weight: bold; margin-bottom: 15px; }
    }
</style>
</head>
<body>

<div class="loader" id="loader">
    <i class="fas fa-gem fa-spin fa-3x" style="color:var(--primary)"></i>
    <h4 style="margin-top:15px;color:var(--primary)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ (V18.0)...</h4>
</div>

<header class="app-header">
    <div class="brand">
        <img src="adora-logo.jpg" alt="Adora" class="logo-img" onerror="this.style.display='none'">
        <div class="brand-info">
            <h1>Ù…Ù†Ø¸ÙˆÙ…Ø© Adora Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h1>
            <p>Ø§Ù„Ù‚Ù†Ø§Øµ</p>
        </div>
    </div>
    <div class="header-tools">
        <button class="btn-chic" onclick="window.print()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn-chic" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Ø§ÙƒØ³ÙŠÙ„</button>
    </div>
</header>

<div class="hero-card" id="uploadCard">
    <div class="upload-box">
        <div class="drop-grid">
            <label class="drop-zone" id="dz-naz">
                <i class="fas fa-file-invoice" style="color:var(--accent)"></i>
                <h3>Ù†Ø²ÙŠÙ„ (Guests)</h3>
                <input accept=".xlsx,.xls,.csv" id="nazeelFile" type="file"/>
            </label>
            <label class="drop-zone" id="dz-book">
                <i class="fas fa-passport" style="color:var(--primary)"></i>
                <h3>Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Booking)</h3>
                <input accept=".xlsx,.xls,.csv" id="bookingFile" type="file"/>
            </label>
        </div>
        <button class="btn-magic" onclick="startEngine()">
            <span>ØªØ­Ù„ÙŠÙ„</span> <i class="fas fa-bolt"></i>
        </button>
    </div>
</div>

<div class="control-panel" id="controlPanel">
    <div class="tax-settings">
        <div class="tax-item">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© <input type="number" id="taxVal" class="tax-inp" value="15"></div>
        <div class="tax-item">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© <input type="number" id="muniVal" class="tax-inp" value="2.5"></div>
    </div>
</div>

<div class="dashboard" id="dashboard">
    <div class="kpi-card k-blue">
        <div class="kpi-icon"><i class="fas fa-book"></i></div>
        <span class="kpi-num" id="kpiBook">0</span>
        <span class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        <div class="sub-stats">
            <div class="mini"><b id="subOk" style="color:var(--primary)">0</b><span>Ù…Ø¤ÙƒØ¯</span></div>
            <div class="mini"><b id="subCan" style="color:#c0392b">0</b><span>Ù…Ù„ØºÙŠ</span></div>
            <div class="mini"><b id="subNos" style="color:#f39c12">0</b><span>NoShow</span></div>
        </div>
    </div>

    <div class="kpi-card k-green">
        <div class="kpi-icon"><i class="fas fa-check"></i></div>
        <span class="kpi-num" id="kpiOk">0</span>
        <span class="kpi-lbl">Ù…Ø·Ø§Ø¨Ù‚</span>
    </div>
    <div class="kpi-card k-purple">
        <div class="kpi-icon"><i class="fas fa-layer-group"></i></div>
        <span class="kpi-num" id="kpiGroup">0</span>
        <span class="kpi-lbl">ØªØ¬Ù…ÙŠØ¹/Øª.ÙŠØ¯ÙˆÙŠ</span>
    </div>
    <div class="kpi-card k-gold">
        <div class="kpi-icon"><i class="fas fa-fingerprint"></i></div>
        <span class="kpi-num" id="kpiMoney">0</span>
        <span class="kpi-lbl">Ø¨ØµÙ…Ø©/ØªÙ…Ø¯ÙŠØ¯</span>
    </div>
    
    <div class="kpi-card">
        <span class="kpi-num" id="kpiRevB" style="color:#003580; font-size:1.3rem">0</span>
        <span class="kpi-lbl" style="font-size:0.65rem">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/be/Booking.com_logo.svg" class="booking-logo"> Ø¥ÙŠØ±Ø§Ø¯
        </span>
    </div>
    <div class="kpi-card">
        <span class="kpi-num" id="kpiRevN" style="color:var(--primary); font-size:1.3rem">0</span>
        <span class="kpi-lbl" style="font-size:0.65rem">Ø¥ÙŠØ±Ø§Ø¯ Ù†Ø²ÙŠÙ„</span>
    </div>
    <div class="kpi-card k-red">
        <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <span class="kpi-num" id="kpiRecover">0</span>
        <span class="kpi-lbl">ØªØ³ÙƒÙŠÙ† (Ø¥Ù„ØºØ§Ø¡)</span>
    </div>
    <div class="kpi-card">
        <span class="kpi-num" id="kpiDiff" style="color:#78909c; font-size:1.3rem">0</span>
        <span class="kpi-lbl" style="font-size:0.65rem">Ø§Ù„ÙØ±Ù‚</span>
    </div>
</div>

<div class="results-wrap" id="resultsArea">
    <div class="filter-pills">
        <div class="pill active" onclick="setFilter('all', this)">Ø§Ù„ÙƒÙ„</div>
        <div class="pill red" onclick="setFilter('conflict', this)">âš ï¸ ØªØ¹Ø§Ø±Ø¶</div>
        <div class="pill" onclick="setFilter('group', this)">ğŸ”— ØªØ¬Ù…ÙŠØ¹/ÙŠØ¯ÙˆÙŠ</div>
        <div class="pill" onclick="setFilter('alias', this)">ğŸ§  Ø°Ø§ÙƒØ±Ø©</div>
        <div class="pill" onclick="setFilter('guess,extension,money', this)">ğŸ’° Ø¨ØµÙ…Ø©/ØªÙ…Ø¯ÙŠØ¯</div>
        <div class="pill" onclick="setFilter('miss', this)">âŒ Ù…ÙÙ‚ÙˆØ¯</div>
    </div>

    <input type="text" class="search-box" id="searchInput" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable()">

    <div class="table-responsive">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="3%" onclick="sortTable(0)"># <i class="fas fa-sort"></i></th>
                    <th width="20%" onclick="sortTable(1)">Ø§Ù„Ø§Ø³Ù… (B) <i class="fas fa-sort"></i></th>
                    <th width="10%" onclick="sortTable(2)">Ø§Ù„Ø­Ø§Ù„Ø© <i class="fas fa-sort"></i></th>
                    <th width="20%" onclick="sortTable(3)">Ø§Ù„Ø§Ø³Ù… (N) <i class="fas fa-sort"></i></th>
                    <th width="12%" onclick="sortTable(4)">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±Ø¨Ø· <i class="fas fa-sort"></i></th>
                    <th width="10%" onclick="sortTable(5)">Ø¨ÙˆÙƒÙŠÙ†Ø¬ <i class="fas fa-sort"></i></th>
                    <th width="10%" onclick="sortTable(6)">Ù†Ø²ÙŠÙ„ <i class="fas fa-sort"></i></th>
                    <th width="8%" onclick="sortTable(7)">Ø§Ù„ÙØ±Ù‚ <i class="fas fa-sort"></i></th>
                    <th width="15%" onclick="sortTable(8)">Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® <i class="fas fa-sort"></i></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="footer-bar">
    ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ | 77aayy@gmail.com
</div>

<script>
let currentFilter = 'all';
let allRowsData = [];
let cachedN = null, cachedB = null;
let db; // IndexedDB instance

// --- IndexedDB Functions (V18.0) ---
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('AdoraMatchDB', 1);

        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('aliases')) {
                db.createObjectStore('aliases', { keyPath: 'bName' });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            resolve(db);
        };

        request.onerror = (e) => {
            console.error("IndexedDB error:", e.target.error);
            reject(e.target.error);
        };
    });
}

function saveAlias(bName, nName) {
    if(!db) return;
    const transaction = db.transaction(['aliases'], 'readwrite');
    const store = transaction.objectStore('aliases');
    store.put({ bName: normalize(bName), nName: normalize(nName) });
}

function getAlias(bName) {
    return new Promise((resolve, reject) => {
        if(!db) { resolve(null); return; }
        const transaction = db.transaction(['aliases'], 'readonly');
        const store = transaction.objectStore('aliases');
        const request = store.get(normalize(bName));
        
        request.onsuccess = (e) => {
            resolve(e.target.result);
        };

        request.onerror = (e) => {
            console.error("Error retrieving alias:", e.target.error);
            resolve(null);
        };
    });
}
// --- End IndexedDB Functions ---


// AI Levenshtein
function levenshtein(a, b) {
    const matrix = [];
    for(let i=0; i<=b.length; i++) matrix[i] = [i];
    for(let j=0; j<=a.length; j++) matrix[0][j] = j;
    for(let i=1; i<=b.length; i++) {
        for(let j=1; j<=a.length; j++) {
            if(b.charAt(i-1)==a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
            else matrix[i][j] = Math.min(matrix[i-1][j-1]+1, Math.min(matrix[i][j-1]+1, matrix[i-1][j]+1));
        }
    }
    return matrix[b.length][a.length];
}

function safeSet(id, v){ if(document.getElementById(id)) document.getElementById(id).textContent = v; }
function cleanPrice(v) { return parseFloat(String(v||0).replace(/[^0-9.]/g, "")) || 0; }

function normalize(s) { 
    return String(s||"").toLowerCase()
        .replace(/[Ø£Ø¥Ø¢]/g,"Ø§").replace(/Ø©/g,"Ù‡").replace(/Ù‰/g,"ÙŠ")
        .replace(/al-/g, "").replace(/al /g, "").replace(/bin /g, "").replace(/abu /g, "")
        .replace(/mr /g, "").replace(/mrs /g, "")
        .replace(/[^\w\u0600-\u06FF]/g," ").trim(); 
}

function parseDate(v) {
    if(!v && v!==0) return null;
    if(typeof v === 'number') return new Date((v - 25569)*86400000);
    if(typeof v === 'string') {
        if(v.includes('-')) { let p = v.split(' ')[0].split('-'); if(p[0].length===4) return new Date(p[0],p[1]-1,p[2]); return new Date(p[2],p[1]-1,p[0]); }
        if(v.includes('/')) { let p = v.split(' ')[0].split('/'); if(p[0].length===4) return new Date(p[0],p[1]-1,p[2]); return new Date(p[2],p[1]-1,p[0]); }
    }
    return null;
}
function toENDateStr(d) { if(!d) return "-"; return d.toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit'}); }
function getParts(name) { return normalize(name).split(" ").filter(x => x.length > 2); }

// V18.0: Diagnostic Difference
function getDiffDiagnosis(diff, bPriceNet, taxMultiplier) {
    const absDiff = Math.abs(diff);
    if (absDiff < 5) return "Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ§Ù…Ø©"; // Almost zero difference
    
    // Check for Tax/Muni difference (17.5%)
    const taxDiff = bPriceNet * (taxMultiplier - 1);
    if (Math.abs(absDiff - taxDiff) < 5) return "ÙØ±Ù‚ Ø¶Ø±ÙŠØ¨Ø©/Ø¨Ù„Ø¯ÙŠØ©";

    // Since we don't know the exact price per night, we check if the difference is a common night price variation (e.g., 20% of net price, covering an extra night at minimum price or a price adjustment)
    const nightGuess = bPriceNet * 0.25; // Heuristic: maybe 25% of net booking price is one night
    if (absDiff > nightGuess) return diff > 0 ? "ØªÙ…Ø¯ÙŠØ¯ Ù„ÙŠÙ„Ø© Ù…Ø­ØªÙ…Ù„" : "ØªØ®ÙÙŠØ¶ Ø³Ø¹Ø±/Ø®ØµÙ…";

    return diff > 0 ? "Ø²ÙŠØ§Ø¯Ø© ØºÙŠØ± Ù…Ø´Ø®ØµØ©" : "Ù†Ù‚ØµØ§Ù† ØºÙŠØ± Ù…Ø´Ø®Øµ";
}


// UI
document.getElementById('nazeelFile').addEventListener('change', function() { document.getElementById('dz-naz').classList.add('file-loaded'); });
document.getElementById('bookingFile').addEventListener('change', function() { document.getElementById('dz-book').classList.add('file-loaded'); });

async function readSheet(file) {
    return new Promise(resolve => {
        const r = new FileReader();
        r.onload = e => { const wb = XLSX.read(e.target.result, {type:'array'}); resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1})); };
        r.readAsArrayBuffer(file);
    });
}
function getData(raw, keys) {
    let hRow = -1; 
    for(let i=0; i<20; i++) { if(raw[i] && keys.every(k => JSON.stringify(raw[i]).includes(k))) { hRow=i; break; } }
    if(hRow===-1) return [];
    let headers = raw[hRow].map(x=>String(x||"").trim());
    return raw.slice(hRow+1).map(r => { let obj={}; headers.forEach((h,i)=>obj[h]=r[i]); return obj; });
}

async function startEngine() {
    const f1 = document.getElementById('nazeelFile').files[0];
    const f2 = document.getElementById('bookingFile').files[0];
    if(!f1 || !f2) { alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª"); return; }

    document.getElementById('loader').style.display = 'flex';
    document.getElementById('uploadCard').style.display = 'none';

    const taxP = parseFloat(document.getElementById('taxVal').value) || 0;
    const muniP = parseFloat(document.getElementById('muniVal').value) || 0;
    const tax = 1 + ((taxP + muniP) / 100);

    await initDB(); // V18.0: Initialize IndexedDB

    setTimeout(async () => {
        try {
            const nRaw = await readSheet(f1); const bRaw = await readSheet(f2);
            cachedN = getData(nRaw, ["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]); 
            let tempB = getData(bRaw, ["Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²", "Ø§Ù„Ø³Ø¹Ø±"]);

            let minD = null, maxD = null;
            cachedN.forEach(r => { let d = parseDate(r["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"]); if(d) { if(!minD || d<minD) minD=d; if(!maxD || d>maxD) maxD=d; } });
            if(minD && maxD) {
                minD.setDate(minD.getDate()-1); maxD.setDate(maxD.getDate()+1);
                cachedB = tempB.filter(b => { let d = parseDate(b["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]); return !d || (d>=minD && d<=maxD); });
            } else { cachedB = tempB; }

            process(cachedB, cachedN, tax);
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('resultsArea').style.display = 'block';

        } catch(e) { alert("Error: " + e.message); location.reload(); }
    }, 100);
}

async function process(booking, nazeel, tax) {
    allRowsData = [];
    let s = { book:0, match:0, money:0, recover:0, group:0, miss:0, revB:0, revN:0 };
    let sub = { ok:0, can:0, nos:0 };
    let takenNazeel = new Set();
    let processedBooking = new Set(); 

    const refKey = Object.keys(nazeel[0]||{}).find(k => k.includes("Ù…Ø±Ø¬Ø¹") || k.includes("Ù…ØµØ¯Ø±")) || "";
    
    booking.forEach(b => {
        s.book++;
        let st = String(b["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").toLowerCase();
        if(st.includes("ok")) sub.ok++; else if(st.includes("cancel")) sub.can++; else sub.nos++;
    });

    // V18.0: 0. Alias Mapping (The Memory)
    await Promise.all(booking.map(async (b, idx) => {
        if(processedBooking.has(idx)) return;
        const bName = b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ\\Ø§Ù„Ø¶ÙŠÙˆÙ"] || b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"];
        const alias = await getAlias(bName);
        
        if (alias) {
            let pool = nazeel.map((n,i)=>({n,i})).filter(x => !takenNazeel.has(x.i));
            let match = pool.find(x => normalize(x.n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]).includes(alias.nName));
            
            if (match) {
                processedBooking.add(idx); takenNazeel.add(match.i);
                storeResult(b, match.n, "alias", s, tax);
            }
        }
    }));


    // 1. Grouping
    let groups = {};
    booking.forEach((b, idx) => {
        if(processedBooking.has(idx)) return; // V18.0: Skip if already processed by alias
        let name = normalize(b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ\\Ø§Ù„Ø¶ÙŠÙˆÙ"] || b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"]);
        if(!groups[name]) groups[name] = [];
        groups[name].push({data: b, idx: idx});
    });

    for(let name in groups) {
        let group = groups[name];
        if(group.length < 2) continue;
        let totalExp = group.reduce((sum, item) => sum + (cleanPrice(item.data["Ø§Ù„Ø³Ø¹Ø±"])*tax), 0);
        let minDate = group.reduce((min, item) => { let d=parseDate(item.data["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]); return (!min||d<min)?d:min; }, null);
        let pool = nazeel.map((n,i)=>({n,i})).filter(x => !takenNazeel.has(x.i));
        let match = pool.find(x => {
            let nPrice = cleanPrice(x.n["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||x.n["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]);
            let nDate = parseDate(x.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"]);
            let priceOk = Math.abs(nPrice - totalExp) <= 10;
            let dateOk = minDate && nDate && Math.abs((nDate - minDate)/864e5) <= 2;
            return priceOk && dateOk;
        });
        if(match) {
            takenNazeel.add(match.i);
            group.forEach((item, i) => {
                processedBooking.add(item.idx);
                storeResult(item.data, (i===0?match.n:null), "group", s, tax, i===0);
            });
        }
    }

    // 2. Waterfall (Individual)
    booking.forEach((b, idx) => {
        if(processedBooking.has(idx)) return;
        const bRef = String(b["Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"]||"").trim();
        const bName = normalize(b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ\\Ø§Ù„Ø¶ÙŠÙˆÙ"] || b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"]);
        const bPrice = cleanPrice(b["Ø§Ù„Ø³Ø¹Ø±"]);
        const expPrice = bPrice * tax;
        const bDate = parseDate(b["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]);
        
        let pool = nazeel.map((n,i)=>({n,i})).filter(x => !takenNazeel.has(x.i));
        let match = null, type = "";

        // Ref
        if(refKey && bRef) {
            let refMatches = pool.filter(x => String(x.n[refKey]||"").includes(bRef));
            if(refMatches.length > 0) {
                let totalNazeelPrice = refMatches.reduce((sum, m) => sum + cleanPrice(m.n["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||m.n["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]), 0);
                let firstMatch = refMatches[0];
                refMatches.forEach(m => takenNazeel.add(m.i));
                processedBooking.add(idx);
                storeResult(b, firstMatch.n, "ref", s, tax, false, totalNazeelPrice);
                return;
            }
        }

        // Name
        if(!match) {
            let bParts = getParts(bName);
            match = pool.find(x => {
                let nName = normalize(x.n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]);
                let nPrice = cleanPrice(x.n["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||x.n["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]);
                let nDate = parseDate(x.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"]);
                let simScore = 0;
                if(bParts.length > 0) {
                    let nParts = getParts(nName);
                    bParts.forEach(bp => { if(nParts.some(np => levenshtein(bp, np) <= 1)) simScore++; });
                }
                let nameHit = (simScore >= 2) || (bParts.length === 1 && simScore === 1);
                let priceHit = Math.abs(nPrice - expPrice) < 10;
                let dateHit = bDate && nDate && Math.abs((nDate - bDate)/864e5) <= 1.5;
                return nameHit && (priceHit || dateHit);
            });
            if(match) type = "name";
        }

        if(match) {
            processedBooking.add(idx); takenNazeel.add(match.i);
            storeResult(b, match.n, type, s, tax);
        }
    });

    // V18.0: 3. Behavioral Extension Check
    booking.forEach((b, idx) => {
        if(processedBooking.has(idx)) return;
        
        const bPrice = cleanPrice(b["Ø§Ù„Ø³Ø¹Ø±"]);
        const expPrice = bPrice * tax;
        const bDate = parseDate(b["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]);
        const bOutDate = parseDate(b["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©"]);

        let pool = nazeel.map((n,i)=>({n,i})).filter(x => !takenNazeel.has(x.i));

        // Find a Nazeel booking whose check-out date is AFTER Booking's check-out date
        let match = pool.find(x => {
            let nPrice = cleanPrice(x.n["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||x.n["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]);
            let nDate = parseDate(x.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"]);
            let nOutDate = parseDate(x.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬"]);
            
            if(!bDate || !nDate || !bOutDate || !nOutDate) return false;

            // Date match check-in (1 day tolerance)
            let dateMatch = Math.abs((nDate - bDate)/864e5) < 1.0; 
            // Extension check: Nazeel Check-out is AFTER Booking Check-out
            let extensionHit = (nOutDate > bOutDate);
            // Price must be close, assuming no extra services
            let priceMatch = Math.abs(nPrice - expPrice) < 15; 

            return dateMatch && extensionHit && priceMatch;
        });

        if(match) {
            processedBooking.add(idx); takenNazeel.add(match.i);
            storeResult(b, match.n, "extension", s, tax);
        }
    });
    
    // 4. ORPHAN SCAVENGER (Price/Date Guess)
    booking.forEach((b, idx) => {
        if(processedBooking.has(idx)) return; 

        const bPrice = cleanPrice(b["Ø§Ù„Ø³Ø¹Ø±"]);
        const expPrice = bPrice * tax;
        const bDate = parseDate(b["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]);

        let pool = nazeel.map((n,i)=>({n,i})).filter(x => !takenNazeel.has(x.i));
        
        let match = pool.find(x => {
            let nPrice = cleanPrice(x.n["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||x.n["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]);
            let nDate = parseDate(x.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"]);
            if(!bDate || !nDate) return false;

            let dateMatch = Math.abs((nDate - bDate)/864e5) < 1.0; 
            let priceDiff = Math.abs(nPrice - expPrice);
            let priceMatch = (priceDiff <= 3.0); 

            return dateMatch && priceMatch;
        });

        if(match) {
            processedBooking.add(idx); takenNazeel.add(match.i);
            storeResult(b, match.n, "guess", s, tax);
        } else {
            storeResult(b, null, "miss", s, tax);
        }
    });

    await applyManuals(s); // V18.0: This now reads from IndexedDB
    updateStats(s, sub);
    renderTable(); 
}

function storeResult(b, n, type, s, tax, isGroupHead, totalNazeelPrice) {
    let bName = b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ\\Ø§Ù„Ø¶ÙŠÙˆÙ"] || b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"] || b["ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ù…Ù† Ù‚ÙØ¨Ù„"];
    let status = String(b["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").toLowerCase();
    let isOk = status.includes("ok");
    let bPriceNet = cleanPrice(b["Ø§Ù„Ø³Ø¹Ø±"]);
    let bPrice = bPriceNet * tax;
    let nPrice = totalNazeelPrice || (n ? cleanPrice(n["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||n["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]) : 0);
    
    if(type !== "miss") {
        if(!isOk) { s.recover++; type="conflict"; }
        else {
            if(type==="ref"||type==="name"||type==="alias") s.match++;
            if(type==="money"||type==="guess"||type==="extension") s.money++; // V18.0: extension is money/fingerprint match
            if(type==="group") s.group++;
        }
        s.revB += bPrice;
        if(type !== "group" || isGroupHead) s.revN += nPrice; 
    } else { if(isOk) s.miss++; }

    allRowsData.push({
        b: b, n: n, type: type, bName: bName, status: status, isOk: isOk,
        bPrice: bPrice, nPrice: nPrice, bPriceNet: bPriceNet, tax: tax,
        timestamp: parseDate(b["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]) || 0
    });
}

function renderTable() {
    const tbody = document.querySelector('#mainTable tbody'); tbody.innerHTML = "";
    const taxMultiplier = parseFloat(document.getElementById('taxVal').value) / 100 + parseFloat(document.getElementById('muniVal').value) / 100 + 1;

    if(!document.getElementById("mainTable").getAttribute("data-sort-col")) {
        allRowsData.sort((a, b) => b.timestamp - a.timestamp);
    }

    allRowsData.forEach((row, idx) => {
        let filters = currentFilter.split(',');
        if(currentFilter !== 'all') {
            if (!filters.includes(row.type)) return;
        }

        let term = document.getElementById('searchInput').value.toLowerCase();
        if(term && !row.bName.toLowerCase().includes(term)) return;

        let tr = document.createElement('tr');
        tr.dataset.type = row.type;

        let tag = "";
        if(row.type==="ref") tag=`<span class="match-tag mt-ok">ğŸ†” Ù…Ø±Ø¬Ø¹</span>`;
        else if(row.type==="name") tag=`<span class="match-tag mt-ok">âœ¨ Ø§Ø³Ù…</span>`;
        else if(row.type==="alias") tag=`<span class="match-tag mt-alias">ğŸ§  Ø°Ø§ÙƒØ±Ø©</span>`; // V18.0
        else if(row.type==="money") tag=`<span class="match-tag mt-warn">ğŸ’° Ø¨ØµÙ…Ø©</span>`;
        else if(row.type==="guess") tag=`<span class="match-tag mt-guess">ğŸ§© ØªØ®Ù…ÙŠÙ† Ø°ÙƒÙŠ</span>`;
        else if(row.type==="extension") tag=`<span class="match-tag mt-ext">ğŸŸ¡ ØªÙ…Ø¯ÙŠØ¯ Ø¥Ù‚Ø§Ù…Ø©</span>`; // V18.0
        else if(row.type==="group") tag=`<span class="match-tag mt-grp">ğŸ”— ØªØ¬Ù…ÙŠØ¹</span>`;
        else if(row.type==="conflict") tag=`<span class="match-tag mt-err">âš ï¸ ØªØ³ÙƒÙŠÙ†</span>`;
        else tag=`<span class="match-tag mt-miss">âŒ Ù…ÙÙ‚ÙˆØ¯</span>`;

        let stHtml = row.isOk ? `<span class="st-ok">Ù…Ø¤ÙƒØ¯</span>` : `<span class="st-no">Ù…Ù„ØºÙŠ</span>`;
        let bDate = toENDateStr(parseDate(row.b["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]));
        let bOut = toENDateStr(parseDate(row.b["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©"]));
        let nDate = row.n ? toENDateStr(parseDate(row.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"])) : "-";
        let nOut = row.n ? toENDateStr(parseDate(row.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬"])) : "-";
        let act = (row.type==="miss") ? `<br><button class="btn-mini bm-merge" onclick="markMerged(this, '${row.bName}')">Ø¯Ù…Ø¬ ÙŠØ¯ÙˆÙŠ</button>` : "";

        let diff = row.n ? (row.nPrice - row.bPrice) : 0;
        let diffHtml = row.n ? (Math.abs(diff)<5 ? `<span class="diff-zero">0</span>` : `<span class="${diff>0?'diff-pos':'diff-neg'}">${diff.toFixed(0)}</span>`) : "-";
        
        // V18.0: Diagnostic Difference
        let diffDiag = "";
        if(row.n && row.type !== 'conflict' && row.type !== 'miss') {
             diffDiag = `<div class="diff-diag">(${getDiffDiagnosis(diff, row.bPriceNet, taxMultiplier)})</div>`;
        }

        tr.innerHTML = `
            <td>${idx+1}</td>
            <td><div class="b-name">${row.bName}</div><div class="b-ref">${row.b["Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"]||""}</div></td>
            <td>${stHtml}</td>
            <td>${row.n ? row.n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"] : "-"}</td>
            <td>${tag}${act}</td>
            <td><span class="price-val">${row.bPrice.toFixed(0)}</span></td>
            <td><span class="price-val">${row.n?row.nPrice.toFixed(0):'-'}</span></td>
            <td>${diffHtml}${diffDiag}</td>
            <td>
                <div class="d-box">
                    <div class="d-line"><span class="d-dot dot-b"></span><span class="txt-b">B: ${bDate} â ${bOut}</span></div>
                    <div class="d-line"><span class="d-dot dot-n"></span><span class="txt-n">N: ${nDate} â ${nOut}</span></div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function updateStats(s, sub) {
    // V18.0: Combine group/alias and money/extension
    let combinedMatch = s.match + s.group;
    let combinedMoney = s.money;

    safeSet('kpiBook', s.book); safeSet('kpiOk', combinedMatch);
    safeSet('kpiGroup', s.group); safeSet('kpiMoney', combinedMoney);
    safeSet('kpiRecover', s.recover);
    safeSet('kpiRevB', s.revB.toLocaleString()); safeSet('kpiRevN', s.revN.toLocaleString());
    safeSet('kpiDiff', (s.revN - s.revB).toLocaleString());
    safeSet('subOk', sub.ok); safeSet('subCan', sub.can); safeSet('subNos', sub.nos);
}

function setFilter(type, btn) {
    document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = type;
    renderTable();
}
function filterTable() { renderTable(); }

function sortTable(n) {
    let table = document.getElementById("mainTable");
    let dir = table.getAttribute("data-sort-dir") === "asc" ? "desc" : "asc";
    table.setAttribute("data-sort-dir", dir);
    table.setAttribute("data-sort-col", n);

    allRowsData.sort((a, b) => {
        let valA, valB;
        switch(n) {
            case 0: return (dir === 'asc') ? 1 : -1; 
            case 1: valA = a.bName; valB = b.bName; break;
            case 2: valA = a.status; valB = b.status; break;
            case 3: valA = a.n ? a.n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"] : ""; valB = b.n ? b.n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"] : ""; break;
            case 4: valA = a.type; valB = b.type; break;
            case 5: valA = a.bPrice; valB = b.bPrice; break;
            case 6: valA = a.nPrice; valB = b.nPrice; break;
            case 7: valA = (a.nPrice - a.bPrice); valB = (b.nPrice - b.bPrice); break;
            case 8: valA = a.timestamp; valB = b.timestamp; break;
        }
        if (typeof valA === 'string') { return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); }
        else { return dir === 'asc' ? valA - valB : valB - valA; }
    });
    renderTable();
}

// V18.0: Save alias to IndexedDB instead of sessionStorage
function markMerged(btn, bName) {
    let tr = btn.closest('tr');
    let nNameEl = tr.querySelector('td:nth-child(4)');
    let nName = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ù†Ø²ÙŠÙ„ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€ ${bName}):`, nNameEl.innerText.trim());
    
    if (nName && nName.trim() !== '-' && nName.trim() !== '') {
        saveAlias(bName, nName);

        let rowData = allRowsData.find(r => r.bName === bName && r.type === 'miss');
        if(rowData) {
            rowData.type = 'alias';
            
            // Heuristic Nazeel matching for display purposes only
            let matchN = cachedN.find(n => normalize(n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]) === normalize(nName));
            if(matchN) {
                rowData.n = matchN;
                rowData.nPrice = cleanPrice(matchN["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||matchN["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]);
                let el = document.getElementById('kpiRevB');
                let elN = document.getElementById('kpiRevN');
                el.innerText = (parseFloat(el.innerText.replace(/,/g,'')) + rowData.bPrice).toLocaleString();
                elN.innerText = (parseFloat(elN.innerText.replace(/,/g,'')) + rowData.nPrice).toLocaleString();
            }

            // Update stats and re-render
            const kpiOk = document.getElementById('kpiOk'); kpiOk.textContent = parseInt(kpiOk.textContent) + 1;
            renderTable(); 
        }
    }
}

// V18.0: This is no longer needed since Alias mapping runs in process(). It is replaced by the async loop in process.
async function applyManuals(s) {
    // This function is now mostly redundant as the 'alias' check is done inside the main process loop using getAlias.
    // However, it can be used to re-calculate stats for *missed* bookings that were manually merged
    // in this session before the alias check ran, or for consistency.
    // For now, let's keep it simple: the process handles the memory.
}

function exportExcel() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(document.getElementById('mainTable'));
    XLSX.utils.book_append_sheet(wb, ws, "Adora_Report");
    XLSX.writeFile(wb, "Adora_Report.xlsx");
}
</script>
</body>
</html>
