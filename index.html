<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ù†Ø¸Ø§Ù… ØµØ§Ø¦Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª â€“ V4.6 Final (Updated)</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    /* =========================================================
       TANAFOS THEME (FIXED & POLISHED)
       ========================================================= */
    :root {
        --bg-body: #f4f6f8; --bg-card: #ffffff;
        --text-main: #37474f; --text-sub: #78909c; --border-color: #cfd8dc;
        --primary: #0097a7; --primary-dark: #006064; --primary-light: #e0f7fa;
        --success: #00b894; --danger: #d63031; --warning: #f1c40f;
        --shadow: 0 4px 20px rgba(0, 151, 167, 0.08); --radius: 16px;
    }

    body { 
        margin: 0; padding: 20px; font-family: 'Tajawal', sans-serif; 
        background-color: var(--bg-body); 
        background-image: radial-gradient(#b0bec5 1px, transparent 1px);
        background-size: 20px 20px; color: var(--text-main); 
    }

    /* --- Header --- */
    .top-header {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
        border: 1px solid #fff; color: var(--primary); padding: 15px 25px; 
        border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px;
    }
    .app-logo { 
        font-size: 1.4rem; font-weight: 800; 
        display: flex; flex-direction: column; align-items: flex-end; text-align: right; gap: 10px;
    }
    .version-badge {
        font-size: 0.9rem; font-weight: 400; padding: 3px 8px;
        border: 1px solid #ccc; border-radius: 8px; background: rgba(255,255,255,0.4);
        display: block; text-align: right;
    }

    /* --- Upload Area --- */
    .upload-card {
        background: var(--bg-card); padding: 20px; border-radius: var(--radius);
        box-shadow: var(--shadow); border: 1px solid var(--border-color);
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;
        margin: 40px auto; width: 100%; max-width: 600px; min-height: 180px;
    }
    .upload-card.hidden, .run-card.hidden { display: none !important; }
    
    .input-group { width: 90%; margin: 0 auto; }
    .input-group h3 { margin: 0 0 8px; font-size: 0.9rem; color: var(--text-sub); font-weight: 700; }
    
    input[type="file"] {
        width: 100%; padding: 15px; background: var(--primary-light); 
        border: 2px dashed var(--primary); border-radius: 12px;
        transition: 0.3s; cursor: pointer; color: var(--text-main);
    }
    input[type="file"]:hover { background: #fff; }

    .run-card { text-align: center; margin-bottom: 40px; margin-top: -40px; }
    .btn-run {
        background: var(--primary); color: white; border: none; 
        padding: 15px 50px; border-radius: 12px; font-weight: 800; font-size: 1.1rem; 
        cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 151, 167, 0.3);
    }
    .btn-run:hover { background: var(--primary-dark); transform: translateY(-2px); }

    .btn-print-screen {
        background: var(--text-main); display: none; color: white; border: none; 
        padding: 8px 15px; border-radius: 8px; font-weight: 700; cursor: pointer; 
        align-items: center; gap: 8px; font-size: 0.85rem;
    }

    /* --- Dashboard --- */
    .dashboard-grid { 
        display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 15px; margin-bottom: 25px; 
    }
    .stat-card {
        background: var(--bg-card); padding: 15px; border-radius: 16px;
        box-shadow: var(--shadow); border: 1px solid var(--border-color);
        border-bottom: 4px solid transparent; text-align: center; position: relative;
    }
    .stat-card.blue { border-bottom-color: #29b6f6; } .stat-card.blue .stat-val { color: #0288d1; }
    .stat-card.green { border-bottom-color: var(--success); } .stat-card.green .stat-val { color: var(--success); }
    .stat-card.gold { border-bottom-color: var(--warning); } .stat-card.gold .stat-val { color: #fbc02d; }
    .stat-card.red { border-bottom-color: var(--danger); } .stat-card.red .stat-val { color: var(--danger); }
    
    .stat-val { font-size: 1.6rem; font-weight: 900; display: block; margin-bottom: 5px; }
    .stat-lbl { font-size: 0.8rem; color: var(--text-sub); font-weight: 600; }
    
    .mini-stats { display: flex; justify-content: center; gap: 10px; font-size: 0.65rem; color: var(--text-sub); margin-top: 5px; border-top: 1px dashed #eee; padding-top: 5px; }

    /* --- Filters & Search --- */
    .filter-bar { display: none; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; align-items: center; }
    .filter-btn {
        background: var(--bg-card); border: 1px solid var(--border-color); 
        padding: 6px 15px; border-radius: 50px; font-weight: 700; color: var(--text-sub); 
        cursor: pointer; transition: 0.2s; font-size: 0.85rem;
    }
    .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .filter-btn.red.active { background: var(--danger); border-color: var(--danger); }
    
    .search-box { position: relative; margin-left: 10px; }
    .search-input {
        padding: 6px 30px 6px 10px; border-radius: 20px; border: 1px solid var(--border-color);
        font-family: inherit; font-size: 0.9rem; width: 180px; transition: 0.3s;
    }
    .search-input:focus { width: 220px; border-color: var(--primary); outline: none; }
    .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 0.8rem; }

    /* --- Table --- */
    .table-wrapper {
        background: var(--bg-card); border-radius: 16px; overflow: hidden;
        box-shadow: var(--shadow); border: 1px solid var(--border-color); 
        display: none; 
    }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    
    thead th {
        background: var(--primary-light); color: var(--primary-dark); padding: 12px; text-align: right;
        font-weight: 700; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); white-space: nowrap;
    }

    tbody td { 
        padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 15px; 
        vertical-align: middle; font-weight: 600; color: var(--text-main); line-height: 1.2;
    }
    tbody tr:hover { background: #fcfcfc; }

    /* --- Badges & Diff --- */
    .badge { 
        padding: 5px 10px; border-radius: 6px; font-size: 13px; font-weight: 800;
        display: inline-flex; align-items: center; gap: 4px; 
    }
    .b-ok { background: #e0f2f1; color: #00695c; }
    .b-fraud { background: #ffebee; color: #c62828; }
    .b-ref { background: #e3f2fd; color: #1565c0; }
    .b-fam { background: #e8f5e9; color: #2e7d32; }
    .b-miss { background: #f5f5f5; color: #9e9e9e; }
    .b-manual { background: #fff3e0; color: #ef6c00; }

    .diff-box { padding: 3px 8px; border-radius: 6px; font-weight: 700; font-size: 0.9rem; text-align: center; min-width: 70px; display: inline-block; cursor:pointer; }
    .diff-pos { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .diff-neg { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    .diff-zero { color: #cfd8dc; font-weight: 400; }

    .date-cell span { font-size: 13px !important; display:block; margin-bottom:2px; }

    .loader { display: none; text-align: center; padding: 40px; font-size: 1.2rem; color: var(--primary); font-weight: 700; }
    .manual-btn { background: var(--primary); color: white; border: none; padding: 3px 8px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.7rem; }

    /* Footer */
    #ayman_footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 11px; color: #78909c; padding: 5px 0; background: rgba(255,255,255,0.9); z-index: 9999; }

    /* Modal */
    #customModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal-box { background: #fff; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
    .modal-input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 8px; font-family: inherit; font-size: 1rem; }

    /* Print */
    @media print {
        @page { size: A4 landscape; margin: 5mm; }
        body { background: #fff; padding: 0; }
        .upload-card, .run-card, .filter-bar, .top-header, #ayman_footer, .dashboard-grid { display: none !important; }
        .table-wrapper { display: block !important; box-shadow: none; border: none; width: 100%; }
        table { width: 100%; border: 1px solid #000; font-size: 11px; }
        th { background: #eee !important; color: #000 !important; border: 1px solid #000 !important; font-size: 12px; }
        td { border: 1px solid #000 !important; padding: 4px; font-size: 5px; }
        table th:last-child, table td:last-child { width: 30% !important; white-space: nowrap; }
        .print-only-footer { display: block !important; text-align: center; font-size: 10px; color: #999; margin-top: 20px; border-top: 1px solid #eee; padding-top: 5px; }
    }
    .print-only-footer { display: none; }
</style>
</head>
<body>

<div class="top-header">
<div class="app-logo">ğŸ’ Ù†Ø¸Ø§Ù… ØµØ§Ø¦Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª <span class="version-badge">Ø£ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ - 0570707121</span></div>
    <div style="display:flex;gap:10px;align-items:center">
        <button class="btn-print-screen" id="printBtn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn-print-screen" id="excelBtn" onclick="exportToExcel()" style="background: linear-gradient(135deg, #1d4ed8, #3b82f6);">ğŸ“Š ØªØµØ¯ÙŠØ±</button>
    </div>
</div>

<div class="upload-card">
    <div class="input-group">
        <h3>1. Ù…Ù„Ù Ù†Ø²ÙŠÙ„ (Guests Report)</h3>
        <input accept=".xlsx,.xls,.csv" id="nazeelFile" type="file"/>
    </div>
    <div class="input-group">
        <h3>2. Ù…Ù„Ù Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Booking Report)</h3>
        <input accept=".xlsx,.xls,.csv" id="bookingFile" type="file"/>
    </div>
</div>

<div class="run-card">
    <button class="btn-run" id="runBtn" onclick="processFiles()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸš€</button>
</div>

<div class="dashboard-grid" id="dashboard">
    <div class="stat-card blue">
        <span class="stat-val" id="kpiBook">0</span>
        <span class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨ÙˆÙƒÙŠÙ†Ø¬</span>
        <div class="mini-stats">
            <span id="subOk">âœ… 0</span> <span id="subCan" style="color:red">ğŸš« 0</span> <span id="subNos" style="color:orange">âš ï¸ 0</span>
        </div>
    </div>
    <div class="stat-card green">
        <span class="stat-val" id="kpiMatch">0</span>
        <span class="stat-lbl">ØªÙ…Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ø³Ù„ÙŠÙ…)</span>
    </div>
    <div class="stat-card gold">
        <span class="stat-val" id="kpiSmart">0</span>
        <span class="stat-lbl">Ø±Ø¨Ø· Ø¹Ø§Ø¦Ù„ÙŠ/Ø°ÙƒÙŠ</span>
    </div>
    <div class="stat-card red">
        <span class="stat-val" id="kpiFraud">0</span>
        <span class="stat-lbl">Ø­Ø§Ù„Ø§Øª Ø§Ø­ØªÙŠØ§Ù„ (Ø®Ø·Ø±)</span>
    </div>
    <div class="stat-card">
        <span class="stat-val" id="kpiRevBook">0</span>
        <span class="stat-lbl">Ø¥ÙŠØ±Ø§Ø¯ Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Ù…Ø·Ø§Ø¨Ù‚)</span>
    </div>
    <div class="stat-card">
        <span class="stat-val" id="kpiRevNaz">0</span>
        <span class="stat-lbl">Ø¥ÙŠØ±Ø§Ø¯ Ù†Ø²ÙŠÙ„ (Ù…Ø·Ø§Ø¨Ù‚)</span>
    </div>
    <div class="stat-card">
        <span class="stat-val" id="kpiDiff">0</span>
        <span class="stat-lbl">ØµØ§ÙÙŠ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</span>
    </div>
    <div class="stat-card" style="border-bottom-color:#cfd8dc">
        <span class="stat-val" id="kpiMissing">0</span>
        <span class="stat-lbl">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù†Ø²ÙŠÙ„</span>
    </div>
</div>

<div class="filter-bar" id="filters">
    <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Ø¨Ø­Ø« (Ø§Ø³Ù…ØŒ Ø±Ù‚Ù…ØŒ Ù…Ø±Ø¬Ø¹)..." onkeyup="filterTable()">
    </div>
    <button class="filter-btn active" onclick="setFilter('all', this)">ğŸ“‹ Ø§Ù„ÙƒÙ„</button>
    <button class="filter-btn red" onclick="setFilter('fraud', this)">ğŸš¨ Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„</button>
    <button class="filter-btn" onclick="setFilter('diff-pos', this)">ğŸ”º Ù†Ø²ÙŠÙ„ Ø£Ø¹Ù„Ù‰</button>
    <button class="filter-btn red" onclick="setFilter('diff-neg', this)">ğŸ”» Ø¨ÙˆÙƒÙŠÙ†Ø¬ Ø£Ø¹Ù„Ù‰</button>
    <button class="filter-btn" onclick="setFilter('ok', this)">âœ… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚</button>
    <button class="filter-btn" onclick="setFilter('missing', this)">âŒ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯</button>
</div>

<div class="loader" id="loader">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø£Ø­Ø¯Ø« Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª...</div>

<div class="table-wrapper" id="tableWrap">
    <table id="resTable">
        <thead>
            <tr>
                <th width="3%">#</th>
                <th width="17%">Ø§Ù„Ø§Ø³Ù… (Booking)</th>
                <th width="8%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th width="17%">Ø§Ù„Ø§Ø³Ù… (Ù†Ø²ÙŠÙ„)</th>
                <th width="10%">Ø§Ù„Ø±Ø¨Ø·</th>
                <th width="10%">Ø¨ÙˆÙƒÙŠÙ†Ø¬</th>
                <th width="10%">Ù†Ø²ÙŠÙ„</th>
                <th width="8%">Ø§Ù„ÙØ±Ù‚</th>
                <th width="25%">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø±ÙƒØ© (In â Out)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="print-only-footer">
    ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… ØµØ§Ø¦Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (ØªØ·ÙˆÙŠØ±: Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ - 77aayy@gmail.com )
</div>

<div id="ayman_footer">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ | 77aayy@gmail.com</div>

<div id="customModal">
    <div class="modal-box">
        <h3 id="modalTitle" style="margin:0 0 10px; color:var(--primary)">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</h3>
        <p id="modalMsg" style="margin:0 0 15px; color:var(--text-sub)">Ø§Ù„Ù†Øµ</p>
        <input id="modalInput" class="modal-input" />
        <div style="text-align:center;">
            <button id="modalOk" style="padding:10px 20px; border:none; background:var(--primary); color:white; border-radius:10px; cursor:pointer;">Ø­Ø³Ù†Ø§Ù‹</button>
            <button id="modalCancel" style="padding:10px 20px; border:none; background:#eee; color:#333; border-radius:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script>
let currentFilter = 'all';

function safeSet(id, v){ document.getElementById(id).textContent = v; }
function cleanPrice(v) { return parseFloat(String(v||0).replace(/[^0-9.]/g, "")) || 0; }
function normalize(s) { return String(s||"").toLowerCase().replace(/[Ø£Ø¥Ø¢]/g,"Ø§").replace(/Ø©/g,"Ù‡").replace(/Ù‰/g,"ÙŠ").replace(/[^\w\u0600-\u06FF]/g," ").trim(); }
function parseDate(v) {
    if(!v && v!==0) return null;
    if(typeof v === 'number') return new Date((v - 25569)*86400000);
    if(typeof v === 'string') {
        if(v.includes('-')) { let p = v.split(' ')[0].split('-'); if(p[0].length===4) return new Date(p[0],p[1]-1,p[2]); return new Date(p[2],p[1]-1,p[0]); }
        if(v.includes('/')) { let p = v.split(' ')[0].split('/'); if(p[0].length===4) return new Date(p[0],p[1]-1,p[2]); return new Date(p[2],p[1]-1,p[0]); }
    }
    return null;
}
function toENDateStr(d) { if(!d) return "-"; return d.toLocaleDateString('en-GB'); }

/* Skeleton logic removed for brevity */
function getSkeleton(str) { return normalize(str).replace(/[aeiou]/g,''); } 
function getFamilySkel(name) { let p = normalize(name).split(" ").filter(x=>x.length>2); return p.length ? getSkeleton(p[p.length-1]) : ""; }

async function readSheet(file) {
    return new Promise(resolve => {
        const r = new FileReader();
        r.onload = e => { const wb = XLSX.read(e.target.result, {type:'array'}); resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1})); };
        r.readAsArrayBuffer(file);
    });
}
function getData(raw, keys) {
    let hRow = -1; for(let i=0; i<20; i++) if(keys.every(k => JSON.stringify(raw[i]).includes(k))) { hRow=i; break; }
    if(hRow===-1) return [];
    let headers = raw[hRow].map(x=>String(x||"").trim());
    return raw.slice(hRow+1).map(r => { let obj={}; headers.forEach((h,i)=>obj[h]=r[i]); return obj; });
}

async function processFiles() {
    const f1 = document.getElementById('nazeelFile').files[0];
    const f2 = document.getElementById('bookingFile').files[0];
    if(!f1 || !f2) { alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
    
    sessionStorage.removeItem('manualMatches'); 
    document.getElementById('loader').style.display = 'block';
    document.getElementById('runBtn').style.display = 'none';

    try {
        const rawN = await readSheet(f1);
        const rawB = await readSheet(f2);
        const nRows = getData(rawN, ["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]);
        const bRows = getData(rawB, ["Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²", "Ø§Ù„Ø³Ø¹Ø±"]);
        const refKey = Object.keys(nRows[0]||{}).find(k=>k.includes("Ù…Ø±Ø¬Ø¹")||k.includes("Ù…ØµØ¯Ø±")) || "";

        runEngine(bRows, nRows, refKey);

        document.getElementById('printBtn').style.display = 'flex';
        document.getElementById('excelBtn').style.display = 'flex';
        document.querySelector('.upload-card').classList.add('hidden');
        document.querySelector('.run-card').classList.add('hidden');

    } catch(e) {
        alert("Ø®Ø·Ø£: " + e.message); console.error(e);
        document.getElementById('runBtn').style.display = 'block';
    }
    document.getElementById('loader').style.display = 'none';
}

function runEngine(booking, nazeel, refKey) {
    const tbody = document.querySelector('#resTable tbody'); tbody.innerHTML = "";
    let s = { book:0, match:0, fraud:0, smart:0, revB:0, revN:0, missing:0 }; 
    let sub = { ok:0, can:0, nos:0 };
    let taken = new Set(); let takenOK = new Set();
    
    // 1. Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± (Scan for Duplicates)
    let bFreq = {}, nFreq = {};
    booking.forEach(b => {
        let nm = normalize(b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ\\Ø§Ù„Ø¶ÙŠÙˆÙ"] || b["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"]);
        bFreq[nm] = (bFreq[nm] || 0) + 1;
    });
    nazeel.forEach(n => {
        let nm = normalize(n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]);
        nFreq[nm] = (nFreq[nm] || 0) + 1;
    });
    
    let okList = booking.filter(b=>String(b["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").toLowerCase().includes("ok"));
    let cxList = booking.filter(b=>!String(b["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").toLowerCase().includes("ok"));
    s.book = booking.length;

    booking.forEach(b => {
        let st = String(b["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").toLowerCase();
        if(st.includes("ok")) sub.ok++;
        else if(st.includes("cancel")) sub.can++;
        else sub.nos++;
    });

    okList.forEach(b => processRow(b, nazeel, taken, refKey, false, s, takenOK, bFreq, nFreq));
    cxList.forEach(b => processRow(b, nazeel, taken, refKey, true, s, takenOK, bFreq, nFreq));
    
    applyStoredManualMatches();

    safeSet('kpiBook', s.book); 
    safeSet('subOk', `âœ… ${sub.ok}`); safeSet('subCan', `ğŸš« ${sub.can}`); safeSet('subNos', `âš ï¸ ${sub.nos}`);
    
    safeSet('kpiMatch', s.match); safeSet('kpiSmart', s.smart);
    safeSet('kpiFraud', s.fraud); safeSet('kpiRevBook', s.revB.toLocaleString());
    safeSet('kpiRevNaz', s.revN.toLocaleString()); safeSet('kpiDiff', (s.revN - s.revB).toLocaleString());
    safeSet('kpiMissing', s.missing);

    document.getElementById('dashboard').style.display = 'grid';
    document.getElementById('filters').style.display = 'flex';
    document.getElementById('tableWrap').style.display = 'block';
    
    reIndexRows(); 
}

function processRow(bRow, nRows, taken, refKey, strictMode, s, takenOK, bFreq, nFreq) {
    const bRef = String(bRow["Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²"]||"").trim();
    const bNameRaw = bRow["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ\\Ø§Ù„Ø¶ÙŠÙˆÙ"] || bRow["Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"];
    const bName = normalize(bNameRaw);
    const bPrice = cleanPrice(bRow["Ø§Ù„Ø³Ø¹Ø±"]);
    const expected = bPrice * 1.175;
    const bDate = parseDate(bRow["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"]);
    const statusRaw = String(bRow["Ø§Ù„Ø­Ø§Ù„Ø©"]||"").toLowerCase();
    
    let statusDisp = statusRaw;
    if(statusRaw.includes("ok")) statusDisp = "ØªÙ… Ø§Ù„Ø­Ø¶ÙˆØ±";
    else if(statusRaw.includes("cancel")) statusDisp = "Ù…Ù„ØºÙŠ";
    else if(statusRaw.includes("no show") || statusRaw.includes("noshow")) statusDisp = "No Show";
    
    // Ù‡Ù„ Ø§Ù„Ø§Ø³Ù… Ù…ÙƒØ±Ø± ÙÙŠ Ø¨ÙˆÙƒÙŠÙ†Ø¬ØŸ
    const isMultiB = (bFreq[bName] > 1);

    let best = null, method = "";

    let candidates = nRows.map((n,i)=>({n,i})).filter(x => !taken.has(x.i));
    if(bDate) candidates = candidates.filter(x => { let nd = parseDate(x.n["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"]); return !nd || Math.abs((nd-bDate)/864e5) <= 3; });

    if(!best && refKey && bRef.length>0) { let m = candidates.find(x => String(x.n[refKey]||"").includes(bRef)); if(m) { best=m; method="ğŸ†” Ù…Ø±Ø¬Ø¹"; } }
    
    if(!best && !strictMode){
        let m = candidates.find(x => normalize(x.n["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]).includes(bName.split(" ")[0])); 
        if(m) { best=m; method="âœ¨ Ø§Ø³Ù…"; }
    }

    if(best) {
        if(strictMode && takenOK && takenOK.has(best.i)) strictMode = false;
        taken.add(best.i); if(!strictMode && takenOK) takenOK.add(best.i);
        let nRow = best.n; let nPrice = cleanPrice(nRow["Ø§Ù„Ø§ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ"]||nRow["Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ"]);
        
        // Ù‡Ù„ Ø§Ù„Ø§Ø³Ù… Ù…ÙƒØ±Ø± ÙÙŠ Ù†Ø²ÙŠÙ„ØŸ
        const nNameNorm = normalize(nRow["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"]);
        const isMultiN = (nFreq[nNameNorm] > 1);

        if(strictMode) { 
            s.fraud++; 
            const diff = nPrice - expected; 
            const type = (diff < -10) ? "fraud-neg" : "fraud"; 
            appendRow(bNameRaw, statusDisp, nRow["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"], "ğŸš¨ Ø§Ø­ØªÙŠØ§Ù„", expected, nPrice, type, nRow, bRow, bRef, isMultiB, isMultiN); 
        } 
        else { 
            s.match++; 
            s.revB += expected; s.revN += nPrice; 
            if(method.includes("Ù…Ø±Ø¬Ø¹")) s.smart++; 
            appendRow(bNameRaw, statusDisp, nRow["Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"], method, expected, nPrice, method.includes("Ù…Ø±Ø¬Ø¹")?"ref":"ok", nRow, bRow, bRef, isMultiB, isMultiN); 
        }
    } else {
        if(!strictMode) { s.missing++; appendRow(bNameRaw, statusDisp, "-", "âŒ Ù…ÙÙ‚ÙˆØ¯", expected, 0, "missing", null, bRow, bRef, isMultiB, false); }
    }
}

function appendRow(bName, status, nName, method, exp, found, type, nRow, bRow, bRef, isMultiB, isMultiN) {
    const tbody = document.querySelector('#resTable tbody');
    const tr = document.createElement('tr');
    
    let diff = found - exp;
    let diffHtml = '';
    
    if(found > exp && exp/1.175 > 10) { const ratio = found / (exp/1.175); if (Math.round(ratio) >= 2 && Math.abs(found - (Math.round(ratio) * (exp/1.175))) <= 10) diff = 0; }

    if(diff > 10) { diffHtml = `<span class="diff-box diff-pos" onclick="editDiffManually(this.closest('tr'))">+${diff.toFixed(0)}</span>`; }
    else if(diff < -10) { diffHtml = `<span class="diff-box diff-neg" onclick="editDiffManually(this.closest('tr'))">${diff.toFixed(0)}</span>`; }
    else { diffHtml = `<span class="diff-box diff-zero">${diff.toFixed(0)}</span>`; }
    if(type === 'missing') diffHtml = '-';

    let badgeClass = "badge";
    if(type.includes('fraud')) badgeClass += " b-fraud"; else if(type==='ref') badgeClass += " b-ref"; else if(type==='missing') badgeClass += " b-miss"; else badgeClass += " b-ok";

    tr.dataset.type = type;
    if(diff > 10) tr.dataset.diff = 'pos'; else if(diff < -10) tr.dataset.diff = 'neg'; else tr.dataset.diff = '';
    if(type.includes('fraud')) tr.style.background = '#fff1f2';
    
    let bIn = bRow ? toENDateStr(parseDate(bRow["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„"])) : "-";
    let bOut = bRow ? toENDateStr(parseDate(bRow["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©"]||bRow["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©"])) : "-";
    let nIn = nRow ? toENDateStr(parseDate(nRow["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„"])) : "-";
    let nOut = nRow ? toENDateStr(parseDate(nRow["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬"]||nRow["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©"])) : "-";

    let datesHtml = `<div class="date-cell">
            <span style="color:#0ea5e9;font-weight:bold;">B: ${bIn} â ${bOut}</span>
            <span style="color:#10b981;font-weight:bold;">N: ${nIn} â ${nOut}</span>
        </div>`;

    let mCell = `<div style="display:flex; flex-direction:column; align-items:center;"><span class="${badgeClass}">${method}</span>`;
    if(type === 'missing' || type === 'fraud-neg') {
        mCell += ` <button class="manual-btn" style="margin-top:2px;" onclick="event.stopPropagation();openManualMatch(this.closest('tr'))">Ø±Ø¨Ø·</button>`;
    }
    if(bRef) mCell += `<span class="ref-sub">#${bRef}</span>`;
    mCell += `</div>`;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ù„Ù„Ù…ØªØ¹Ø¯Ø¯
    const star = `<span style="color:red; font-weight:900; font-size:1.4em; vertical-align:middle; margin-right:4px;" title="Ø­Ø¬Ø² Ù…ØªÙƒØ±Ø±">*</span>`;
    const bNameDisplay = isMultiB ? `${bName} ${star}` : bName;
    const nNameDisplay = isMultiN ? `${nName} ${star}` : nName;

    tr.innerHTML = `<td>0</td>
        <td style="font-weight:700">${bNameDisplay}</td>
        
        <td style="text-align:center;">
            <span style="font-size:12px; font-weight:500; color:#000; background:#00808080; padding:4px 8px; border-radius:6px; display:inline-block; letter-spacing:0.5px;">
                ${status}
            </span>
        </td>
        
        <td>${nNameDisplay}</td>
        <td>${mCell}</td>
        <td>${exp.toFixed(0)}</td>
        <td>${found.toFixed(0)}</td>
        <td>${diffHtml}</td>
        <td>${datesHtml}</td>`;
        
    tbody.appendChild(tr);
}

/* Manual Match */
async function editDiffManually(tr) {
    if(tr.dataset.type === 'manual') { alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ ØµÙ Ù…Ø±Ø¨ÙˆØ· ÙŠØ¯ÙˆÙŠØ§Ù‹."); return; }
    const bName = tr.querySelector('td:nth-child(2)').innerText;
    const oldB = parseFloat(tr.querySelector('td:nth-child(6)').textContent);
    let newVal = await sweetPrompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±", `Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø¨ÙˆÙƒÙŠÙ†Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${bName}`, oldB);
    if(newVal === null) return;
    const newB = cleanPrice(newVal);
    tr.querySelector('td:nth-child(6)').textContent = newB.toFixed(0);
    const nPrice = parseFloat(tr.querySelector('td:nth-child(7)').textContent);
    const newDiff = nPrice - newB;
    const diffCell = tr.querySelector('td:nth-child(8)');
    if(newDiff > 10) { diffCell.innerHTML = `<span class="diff-box diff-pos" onclick="editDiffManually(this.closest('tr'))">+${newDiff.toFixed(0)}</span>`; tr.dataset.diff='pos'; }
    else if(newDiff < -10) { diffCell.innerHTML = `<span class="diff-box diff-neg" onclick="editDiffManually(this.closest('tr'))">${newDiff.toFixed(0)}</span>`; tr.dataset.diff='neg'; }
    else { diffCell.innerHTML = `<span class="diff-box diff-zero">${newDiff.toFixed(0)}</span>`; tr.dataset.diff=''; }
}

function openManualMatch(tr) {
    const bName = tr.querySelector('td:nth-child(2)').innerText.trim();
    const expText = tr.querySelector('td:nth-child(6)').textContent.trim().replace(/,/g,'') || '0';
    sweetPrompt("Ø±Ø¨Ø· ÙŠØ¯ÙˆÙŠ", `Ø§Ø³Ù… Ø§Ù„Ù†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€: ${bName}`, bName).then(name => {
        if(!name) return;
        sweetPrompt("Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ", `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙØ¹Ù„ÙŠ (Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${expText})`, expText).then(price => {
            if(price === null) return;
            applyManualMatch(tr, name, cleanPrice(price));
        });
    });
}

function applyManualMatch(tr, name, price) {
    const bName = tr.querySelector('td:nth-child(2)').innerText;
    let arr = JSON.parse(sessionStorage.getItem('manualMatches')||'[]');
    arr = arr.filter(x => x.bookingName !== bName);
    arr.push({bookingName:bName, manualName:name, manualPrice:price});
    sessionStorage.setItem('manualMatches', JSON.stringify(arr));
    
    tr.querySelector('td:nth-child(4)').textContent = name;
    const mCell = tr.querySelector('td:nth-child(5)');
    mCell.innerHTML = `<span class="badge b-manual">ÙŠØ¯ÙˆÙŠ âœ”ï¸</span>`;
    tr.dataset.type = 'manual';
    tr.style.background = '#fff'; 
    
    tr.querySelector('td:nth-child(7)').textContent = price.toFixed(0);
    const exp = parseFloat(tr.querySelector('td:nth-child(6)').textContent);
    const diff = price - exp;
    const diffCell = tr.querySelector('td:nth-child(8)');
    if(diff > 10) { diffCell.innerHTML = `<span class="diff-box diff-pos" onclick="editDiffManually(this.closest('tr'))">+${diff.toFixed(0)}</span>`; tr.dataset.diff='pos'; }
    else if(diff < -10) { diffCell.innerHTML = `<span class="diff-box diff-neg" onclick="editDiffManually(this.closest('tr'))">${diff.toFixed(0)}</span>`; tr.dataset.diff='neg'; }
    else { diffCell.innerHTML = `<span class="diff-box diff-zero">${diff.toFixed(0)}</span>`; tr.dataset.diff=''; }
    
    // Recalculate Revenue
    let revB = parseFloat(document.getElementById('kpiRevBook').innerText.replace(/,/g,'')) || 0;
    let revN = parseFloat(document.getElementById('kpiRevNaz').innerText.replace(/,/g,'')) || 0;
    revB += exp; revN += price;
    document.getElementById('kpiRevBook').innerText = revB.toLocaleString();
    document.getElementById('kpiRevNaz').innerText = revN.toLocaleString();
    document.getElementById('kpiDiff').innerText = (revN - revB).toLocaleString();
}

function applyStoredManualMatches() {
    const arr = JSON.parse(sessionStorage.getItem('manualMatches')||'[]');
    const rows = document.querySelectorAll('#resTable tbody tr');
    arr.forEach(mm => {
        for(let tr of rows) {
            if(tr.querySelector('td:nth-child(2)').innerText === mm.bookingName) {
                applyManualMatch(tr, mm.manualName, mm.manualPrice); break;
            }
        }
    });
}

/* FILTERS & SEARCH */
function setFilter(type, btn) {
    if(btn) { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    currentFilter = type;
    filterTable();
}

function filterTable() {
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#resTable tbody tr');
    
    rows.forEach(tr => {
        const t = tr.dataset.type;
        const diffStr = tr.dataset.diff;
        let visible = false;

        if(currentFilter === 'all') visible = true;
        else if(currentFilter === 'fraud') visible = (t === 'fraud' || t === 'fraud-neg');
        else if(currentFilter === 'diff-pos') visible = (diffStr === 'pos');
        else if(currentFilter === 'diff-neg') visible = (diffStr === 'neg');
        else if(currentFilter === 'ok') visible = (t === 'ok' || t === 'ref' || t === 'family' || t === 'manual');
        else visible = (t === currentFilter);

        if(visible && searchVal) {
            const txt = tr.innerText.toLowerCase();
            if(!txt.includes(searchVal)) visible = false;
        }

        tr.style.display = visible ? '' : 'none';
    });
    
    reIndexRows();
}

function reIndexRows() {
    let idx = 1;
    document.querySelectorAll('#resTable tbody tr').forEach(tr => {
        if(tr.style.display !== 'none') {
            tr.querySelector('td:first-child').innerText = idx++;
        }
    });
}

/* Export */
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(document.getElementById('resTable'));
    XLSX.utils.book_append_sheet(wb, ws, "Audit Report");
    XLSX.writeFile(wb, "Audit_Report.xlsx");
}

/* Modal Prompt */
function sweetPrompt(title, msg, def) {
    return new Promise(resolve => {
        const m = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMsg').innerText = msg;
        const inp = document.getElementById('modalInput');
        inp.value = def;
        m.style.display = 'flex';
        inp.focus();
        document.getElementById('modalOk').onclick = () => { m.style.display='none'; resolve(inp.value); };
        document.getElementById('modalCancel').onclick = () => { m.style.display='none'; resolve(null); };
    });
}
</script>
</body>
</html>
